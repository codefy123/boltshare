<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashShare | Turbo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --primary: #6366f1; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: #f8fafc; overflow: hidden; height: 100vh; }
        
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); }
        .view { transition: transform 0.4s ease, opacity 0.4s ease; position: absolute; width: 100%; height: 100%; top: 0; left: 0; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        .hidden-right { opacity: 0; pointer-events: none; transform: translateX(50px); }
        .hidden-left { opacity: 0; pointer-events: none; transform: translateX(-50px); }
        
        /* Smooth Loader */
        .scan-line { height: 2px; width: 100%; background: linear-gradient(90deg, transparent, var(--primary), transparent); animation: scan 2s linear infinite; }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* Toast */
        #toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 999; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { pointer-events: auto; background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; rounded-xl; font-size: 14px; font-weight: 500; box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: slideIn 0.3s ease forwards; display: flex; items-center; gap: 10px; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="toast-box"></div>

    <section id="view-home" class="view justify-center items-center">
        <div class="w-full max-w-sm space-y-6">
            
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 mb-4">
                    <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                    <span class="text-[10px] font-bold text-indigo-300 tracking-wider">TURBO MODE ACTIVE</span>
                </div>
                <h1 class="text-3xl font-bold text-white tracking-tight">FlashShare</h1>
                <p class="text-slate-400 text-sm mt-2">High-Speed Local Transfer</p>
            </div>

            <div class="glass rounded-2xl p-1">
                <div class="bg-slate-900/50 rounded-xl p-6 space-y-6">
                    
                    <div class="text-center">
                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-2">Your ID</p>
                        <div class="flex items-center justify-center gap-3 cursor-pointer group" onclick="copyId()">
                            <h2 class="text-4xl font-bold text-white tracking-tighter group-hover:text-indigo-400 transition-colors" id="my-id">...</h2>
                            <i data-lucide="copy" class="w-4 h-4 text-slate-600 group-hover:text-indigo-400"></i>
                        </div>
                    </div>

                    <div class="h-px bg-slate-800 w-full"></div>

                    <div class="space-y-3">
                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest text-center">Connect to Partner</p>
                        <div class="relative">
                            <input type="tel" id="partner-id" maxlength="4" placeholder="0000" class="w-full bg-slate-950/50 border border-slate-700 focus:border-indigo-500 text-white text-center text-xl font-bold py-3 rounded-lg outline-none transition-all placeholder:text-slate-700 tracking-widest">
                        </div>
                        <button onclick="connect()" id="btn-conn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition-all active:scale-[0.98] shadow-lg shadow-indigo-600/20">
                            Connect
                        </button>
                    </div>
                </div>
            </div>

            <p class="text-xs text-center text-slate-500">
                Ensure both devices are on the same <strong>Hotspot</strong> or <strong>WiFi</strong>.
            </p>
        </div>
    </section>

    <section id="view-dash" class="view hidden-right">
        
        <header class="flex justify-between items-center mb-6 z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center text-emerald-400">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-white">Connected</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-400" id="conn-status">Checking type...</span>
                    </div>
                </div>
            </div>
            <button onclick="disconnect()" class="p-2 text-slate-400 hover:text-red-400 transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </header>

        <div onclick="document.getElementById('file-input').click()" class="glass flex-1 max-h-[250px] rounded-2xl border-2 border-dashed border-slate-700 hover:border-indigo-500 hover:bg-slate-800/30 transition-all cursor-pointer flex flex-col items-center justify-center group relative overflow-hidden mb-6">
            <input type="file" id="file-input" class="hidden" multiple onchange="handleFiles(this)">
            
            <div class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            
            <div class="w-16 h-16 bg-slate-900 rounded-full flex items-center justify-center mb-4 shadow-xl border border-slate-800 group-hover:scale-110 transition-transform">
                <i data-lucide="upload-cloud" class="w-7 h-7 text-indigo-400"></i>
            </div>
            <h2 class="text-lg font-bold text-white">Tap to Send Files</h2>
            <p class="text-xs text-slate-400 mt-1">Photos, Videos, Apps</p>
        </div>

        <div class="flex-1 glass rounded-2xl flex flex-col overflow-hidden min-h-[300px]">
            <div class="px-4 py-3 border-b border-slate-800 bg-slate-900/40 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400 uppercase">Activity</span>
                <span class="text-xs font-mono font-bold text-indigo-400" id="global-speed">0.0 MB/s</span>
            </div>
            <div id="file-list" class="flex-1 overflow-y-auto p-3 space-y-3">
                <div id="empty-msg" class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                    <i data-lucide="activity" class="w-8 h-8 mb-2"></i>
                    <p class="text-xs">No active transfers</p>
                </div>
            </div>
        </div>
    </section>

    <template id="row-tpl">
        <div class="bg-slate-800/60 rounded-xl p-3 border border-slate-700/50 relative overflow-hidden">
            <div class="flex items-center gap-3 relative z-10">
                <div class="icon-box w-10 h-10 rounded-lg bg-slate-900 flex items-center justify-center shrink-0 border border-slate-700">
                    <i data-lucide="file" class="w-5 h-5 text-slate-400"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-1.5">
                        <p class="fname text-sm font-medium text-slate-200 truncate">File.ext</p>
                        <p class="fstatus text-[10px] font-bold text-slate-500 uppercase">Waiting</p>
                    </div>
                    <div class="h-1.5 w-full bg-slate-900 rounded-full overflow-hidden">
                        <div class="fbar h-full bg-indigo-500 w-0 transition-all duration-100"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- CONFIG ---
        const PEER_CONFIG = {
            // Use Google's Public STUN server to fix Hotspot NAT issues
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ],
            debug: 1
        };

        const CHUNK_SIZE = 64 * 1024; // 64KB (Safe Max)
        // High water mark: If buffer > 16MB, stop reading. Low water: 1MB.
        const BUFFER_HIGH = 16 * 1024 * 1024; 
        const BUFFER_LOW = 1 * 1024 * 1024;

        lucide.createIcons();
        const myId = Math.floor(1000 + Math.random() * 9000).toString();
        
        // --- DOM ---
        const els = {
            home: document.getElementById('view-home'),
            dash: document.getElementById('view-dash'),
            myId: document.getElementById('my-id'),
            pInput: document.getElementById('partner-id'),
            fileList: document.getElementById('file-list'),
            speed: document.getElementById('global-speed'),
            status: document.getElementById('conn-status'),
            toast: document.getElementById('toast-box'),
            empty: document.getElementById('empty-msg')
        };

        els.myId.innerText = myId;

        // --- STATE ---
        let peer, conn;
        let activeTx = {}; // { id: { writer, type, size, transferred, start } }
        let currentFileId = null; // Binary stream lock

        // --- 1. NETWORK & CONNECTION ---
        function init() {
            peer = new Peer(myId, PEER_CONFIG);
            
            peer.on('open', id => console.log('Ready:', id));
            
            peer.on('connection', c => {
                handleConn(c);
            });
            
            peer.on('error', err => {
                console.error(err);
                notify('Connection Failed. Retrying...', 'err');
                if(err.type === 'disconnected') peer.reconnect();
            });
        }
        init();

        function connect() {
            const pid = els.pInput.value.trim();
            if(pid.length !== 4) return notify('Invalid ID', 'err');
            
            document.getElementById('btn-conn').innerText = "Connecting...";
            const c = peer.connect(pid, { reliable: true });
            handleConn(c);
        }

        function handleConn(c) {
            conn = c;
            
            conn.on('open', () => {
                // UI Switch
                els.home.classList.add('hidden-left');
                els.dash.classList.remove('hidden-right');
                
                // Connection Type Check (Wait 1s for ICE to settle)
                setTimeout(() => {
                    // Check if candidate type is 'host' (Local) or 'srflx/relay' (Internet)
                    // Note: PeerJS doesn't expose ICE details easily, but we can guess by speed later.
                    // For now, assume connected.
                    els.status.innerText = "Secure P2P Link";
                    els.status.classList.add('text-emerald-400');
                    notify("Connected Successfully!");
                }, 500);
            });

            conn.on('data', data => {
                // Data Router
                if(data.constructor === ArrayBuffer || data.constructor === Uint8Array) {
                    handleBinary(data);
                } else {
                    handleMessage(data);
                }
            });

            conn.on('close', () => {
                notify("Disconnected", 'err');
                setTimeout(() => location.reload(), 1500);
            });
            
            conn.on('error', () => notify("Link Error", 'err'));
        }

        // --- 2. FAST TRANSFER ENGINE ---
        
        // A. SENDER
        function handleFiles(input) {
            const files = Array.from(input.files);
            if(!files.length) return;
            files.forEach(processUpload);
            input.value = '';
        }

        async function processUpload(file) {
            const id = Date.now().toString(36);
            createRow(id, file.name, 'up');
            
            // 1. Send Header
            conn.send({ type: 'start', id, name: file.name, size: file.size });

            // 2. Stream Data
            const reader = new FileReader();
            let offset = 0;
            
            // Speed Calc
            let lastTime = Date.now();
            let bytesSince = 0;

            const readChunk = () => {
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };

            reader.onload = async (e) => {
                if(!conn) return;
                
                // SMART BUFFER MANAGEMENT (The Speed Fix)
                if (conn.dataChannel.bufferedAmount > BUFFER_HIGH) {
                    await waitForDrain();
                }

                // SEND RAW BYTES (The Overhead Fix)
                conn.send(e.target.result); 

                offset += e.target.result.byteLength;
                bytesSince += e.target.result.byteLength;

                // UI Update (Throttled 500ms)
                const now = Date.now();
                if(now - lastTime > 500) {
                    const mbps = (bytesSince / 1024 / 1024) / ((now - lastTime) / 1000);
                    els.speed.innerText = mbps.toFixed(1) + " MB/s";
                    updateRow(id, offset / file.size);
                    lastTime = now;
                    bytesSince = 0;
                }

                if(offset < file.size) {
                    readChunk();
                } else {
                    finishRow(id);
                    els.speed.innerText = "0.0 MB/s";
                }
            };

            readChunk();
        }

        function waitForDrain() {
            return new Promise(resolve => {
                const check = () => {
                    if (conn.dataChannel.bufferedAmount < BUFFER_LOW) resolve();
                    else setTimeout(check, 5); // Check aggressively
                };
                check();
            });
        }

        // B. RECEIVER
        function handleMessage(msg) {
            if(msg.type === 'start') {
                createRow(msg.id, msg.name, 'down');
                
                // Initialize StreamSaver
                const fileStream = streamSaver.createWriteStream(msg.name, { size: msg.size });
                const writer = fileStream.getWriter();
                
                activeTx[msg.id] = {
                    writer,
                    total: msg.size,
                    received: 0,
                    start: Date.now(),
                    bytesSince: 0,
                    lastTime: Date.now()
                };
                
                // Lock this transfer as the current binary target
                // (Simple sequential logic for stability)
                currentFileId = msg.id;
            }
        }

        function handleBinary(data) {
            if(!currentFileId || !activeTx[currentFileId]) return;
            
            const tx = activeTx[currentFileId];
            const arr = new Uint8Array(data);
            
            tx.writer.write(arr);
            tx.received += arr.length;
            tx.bytesSince += arr.length;

            // UI Speed
            const now = Date.now();
            if(now - tx.lastTime > 500) {
                const mbps = (tx.bytesSince / 1024 / 1024) / ((now - tx.lastTime) / 1000);
                els.speed.innerText = mbps.toFixed(1) + " MB/s";
                updateRow(currentFileId, tx.received / tx.total);
                tx.lastTime = now;
                tx.bytesSince = 0;
            }

            if(tx.received >= tx.total) {
                tx.writer.close();
                finishRow(currentFileId);
                els.speed.innerText = "0.0 MB/s";
                delete activeTx[currentFileId];
                currentFileId = null;
            }
        }

        // --- UI HELPERS ---
        function createRow(id, name, type) {
            els.empty.style.display = 'none';
            const tpl = document.getElementById('row-tpl').content.cloneNode(true);
            const el = tpl.querySelector('div');
            el.id = `Row-${id}`;
            el.querySelector('.fname').innerText = name;
            
            const icon = el.querySelector('.icon-box i');
            const box = el.querySelector('.icon-box');
            
            if(type === 'up') {
                box.classList.add('border-indigo-500/30', 'bg-indigo-500/10');
                icon.classList.replace('text-slate-400', 'text-indigo-400');
                icon.setAttribute('data-lucide', 'arrow-up');
            } else {
                box.classList.add('border-emerald-500/30', 'bg-emerald-500/10');
                icon.classList.replace('text-slate-400', 'text-emerald-400');
                icon.setAttribute('data-lucide', 'arrow-down');
            }
            
            els.fileList.prepend(el);
            lucide.createIcons();
        }

        function updateRow(id, pct) {
            const row = document.getElementById(`Row-${id}`);
            if(row) {
                const p = Math.floor(pct * 100);
                row.querySelector('.fbar').style.width = `${p}%`;
                row.querySelector('.fstatus').innerText = `${p}%`;
            }
        }

        function finishRow(id) {
            const row = document.getElementById(`Row-${id}`);
            if(row) {
                row.querySelector('.fbar').classList.replace('bg-indigo-500', 'bg-emerald-500');
                row.querySelector('.fstatus').innerText = "DONE";
                row.querySelector('.fstatus').classList.add('text-emerald-400');
            }
        }

        function notify(msg, type='info') {
            const t = document.createElement('div');
            t.className = 'toast';
            const color = type === 'err' ? 'text-red-400' : 'text-emerald-400';
            const icon = type === 'err' ? 'alert-circle' : 'check-circle';
            t.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${color}"></i> <span>${msg}</span>`;
            els.toast.appendChild(t);
            lucide.createIcons();
            setTimeout(() => {
                t.style.opacity = '0';
                setTimeout(() => t.remove(), 300);
            }, 3000);
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            notify("ID Copied!");
        }

        function disconnect() {
            if(conn) conn.close();
            location.reload();
        }
    </script>
</body>
</html>
