<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashShare | Enterprise</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #030712; /* Slate 950 */
            --panel: #0f172a; /* Slate 900 */
            --border: #1e293b; /* Slate 800 */
            --primary: #6366f1; /* Indigo 500 */
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg);
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Minimalist Panel */
        .glass-panel { 
            background: var(--panel); 
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Toast */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; background: #1e293b; border: 1px solid #334155; padding: 12px 20px; rounded-lg; display: flex; items-center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; min-width: 300px; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.success { border-left: 4px solid #10b981; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

        /* Inputs */
        .input-minimal { background: transparent; border: none; border-bottom: 2px solid var(--border); color: white; padding: 10px 0; width: 100%; border-radius: 0; transition: border-color 0.3s; }
        .input-minimal:focus { outline: none; border-color: var(--primary); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="w-full p-6 flex justify-between items-center z-50">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-indigo-500 rounded-full"></div>
            <h1 class="font-semibold text-sm tracking-wide text-slate-300">FlashShare <span class="text-slate-600">Ent.</span></h1>
        </div>
        <div class="text-xs font-mono text-slate-500" id="nav-id">Initializing...</div>
    </nav>

    <div id="toast-container"></div>

    <section id="view-home" class="flex-1 flex flex-col items-center justify-center p-6 slide-up">
        <div class="w-full max-w-sm">
            
            <div class="glass-panel rounded-2xl p-8 space-y-8 relative overflow-hidden">
                
                <div>
                    <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-2">Your Device ID</p>
                    <div class="flex items-end justify-between">
                        <h2 class="text-4xl font-mono font-medium text-white tracking-tighter" id="my-code">....</h2>
                        <button onclick="copyCode()" class="text-slate-500 hover:text-white transition-colors pb-2">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="h-px bg-slate-800 w-full"></div>

                <div class="space-y-6">
                    <div>
                        <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-2">Connect to Partner</p>
                        <input type="text" id="partner-code" maxlength="4" placeholder="Enter 4-Digit ID" 
                            class="input-minimal font-mono text-xl placeholder:text-slate-700 uppercase">
                    </div>

                    <button onclick="initiateConnection()" id="btn-connect"
                        class="w-full bg-white text-slate-950 hover:bg-slate-200 font-medium py-3 rounded-lg transition-all active:scale-[0.98]">
                        Secure Connect
                    </button>
                </div>

                <div id="loader-overlay" class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center hidden">
                    <div class="flex flex-col items-center gap-3">
                        <div class="w-5 h-5 border-2 border-slate-600 border-t-white rounded-full animate-spin"></div>
                        <span class="text-xs text-slate-300 font-medium">Verifying Network...</span>
                    </div>
                </div>

            </div>
            
            <p class="text-center text-xs text-slate-600 mt-6">
                Same-Network Connection Only. <br> End-to-End Encrypted.
            </p>
        </div>
    </section>

    <section id="view-dashboard" class="hidden flex-1 flex flex-col p-4 md:p-8 fade-in h-screen">
        
        <div class="flex items-center justify-between mb-8 max-w-4xl mx-auto w-full">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 text-indigo-400">
                    <i data-lucide="laptop" class="w-5 h-5"></i>
                </div>
                <div>
                    <p class="text-xs text-slate-500 uppercase font-bold">Connected To</p>
                    <p class="text-sm text-white font-medium font-mono" id="dash-partner">...</p>
                </div>
            </div>
            <button onclick="disconnect()" class="text-xs text-red-400 hover:text-red-300 transition-colors border border-red-900/50 bg-red-950/20 px-3 py-1.5 rounded-md">
                Disconnect
            </button>
        </div>

        <div class="flex-1 max-w-4xl mx-auto w-full flex flex-col gap-6">
            
            <div onclick="triggerFileSelect()" class="glass-panel border-dashed border-slate-700 hover:border-indigo-500/50 rounded-xl flex-1 max-h-[300px] flex flex-col items-center justify-center cursor-pointer group transition-all">
                <input type="file" id="file-input" class="hidden" multiple onchange="handleFileSelect(this)">
                <div class="w-12 h-12 bg-slate-900 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform border border-slate-800">
                    <i data-lucide="plus" class="w-6 h-6 text-indigo-400"></i>
                </div>
                <h3 class="text-lg font-medium text-slate-200">Send Files</h3>
                <p class="text-xs text-slate-500 mt-1">Click to browse</p>
            </div>

            <div id="transfer-container" class="hidden glass-panel rounded-xl p-0 overflow-hidden flex-1 min-h-[200px] flex flex-col">
                <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Active Transfers</h3>
                    <span class="text-[10px] font-mono text-indigo-400" id="speed-indicator">0.0 MB/s</span>
                </div>
                <div id="file-list" class="p-2 overflow-y-auto flex-1 space-y-2"></div>
            </div>

        </div>
    </section>

    <template id="file-row-template">
        <div class="bg-slate-900/50 rounded-lg p-3 border border-slate-800 flex items-center gap-3 group">
            <div class="w-8 h-8 rounded bg-slate-950 flex items-center justify-center shrink-0 text-slate-400 file-icon">
                <i data-lucide="file" class="w-4 h-4"></i>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex justify-between items-center mb-1">
                    <p class="text-xs text-slate-200 font-medium truncate pr-2 file-name">File.txt</p>
                    <span class="text-[10px] text-slate-500 font-mono file-size">0 MB</span>
                </div>
                <div class="h-1 bg-slate-800 rounded-full overflow-hidden">
                    <div class="progress-bar h-full bg-indigo-500 w-0 transition-all duration-200"></div>
                </div>
            </div>
            <button class="btn-cancel text-slate-600 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </template>

    <script>
        // --- 1. CONFIG & UTILS ---
        lucide.createIcons();
        
        // Generate Identity
        const myCode = Math.floor(1000 + Math.random() * 9000).toString();
        const myName = "Device-" + myCode; // Simplified identity

        // DOM Elements
        const els = {
            views: { home: document.getElementById('view-home'), dash: document.getElementById('view-dashboard') },
            myCode: document.getElementById('my-code'),
            navId: document.getElementById('nav-id'),
            partnerInput: document.getElementById('partner-code'),
            dashPartner: document.getElementById('dash-partner'),
            fileList: document.getElementById('file-list'),
            transferBox: document.getElementById('transfer-container'),
            speed: document.getElementById('speed-indicator'),
            loader: document.getElementById('loader-overlay'),
            toastContainer: document.getElementById('toast-container')
        };

        // UI Initialization
        els.myCode.innerText = myCode;
        els.navId.innerText = `ID: ${myCode}`;

        // Global State
        let peer = null;
        let conn = null;
        let activeTransfers = {}; // { id: { cancel: fn, type: 'up/down', writer, etc } }

        // --- 2. NOTIFICATION SYSTEM (Replacement for Alert) ---
        function showToast(msg, type = 'normal') {
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            
            const icon = type === 'error' ? 'alert-circle' : (type === 'success' ? 'check-circle' : 'info');
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-emerald-400' : 'text-slate-400');
            
            el.innerHTML = `
                <i data-lucide="${icon}" class="w-5 h-5 ${color}"></i>
                <span class="text-sm text-slate-200 font-medium">${msg}</span>
            `;
            
            els.toastContainer.appendChild(el);
            lucide.createIcons();

            // Auto remove
            setTimeout(() => {
                el.style.animation = 'toastOut 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- 3. PEERJS SETUP ---
        function initPeer() {
            peer = new Peer(myCode);
            
            peer.on('open', (id) => console.log('Peer Ready:', id));
            
            peer.on('connection', (connection) => {
                // Incoming Connection Request
                handleIncomingConnection(connection);
            });

            peer.on('error', (err) => {
                console.error(err);
                if(err.type === 'peer-unavailable') showToast("Device not found. Check ID.", 'error');
                else showToast("Connection Error", 'error');
                els.loader.classList.add('hidden');
            });
        }
        initPeer();

        // --- 4. CONNECTION LOGIC (With Strict IP Check) ---
        
        async function getPublicIP() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                return data.ip;
            } catch (e) {
                console.error("IP Fetch Failed", e);
                return "unknown"; // Fallback for offline LAN setups
            }
        }

        async function initiateConnection() {
            const code = els.partnerInput.value.trim();
            if(code.length !== 4) return showToast("Enter a valid 4-digit code", 'error');
            if(code === myCode) return showToast("Cannot connect to yourself", 'error');

            // 1. Show UI Loader
            els.loader.classList.remove('hidden');

            // 2. Fetch My IP
            const myIP = await getPublicIP();

            // 3. Connect with Metadata (Handshake)
            const connection = peer.connect(code, { 
                metadata: { ip: myIP } 
            });

            setupConnectionEvents(connection, myIP, true);
        }

        async function handleIncomingConnection(connection) {
             // 1. Fetch My IP to compare
             const myIP = await getPublicIP();
             setupConnectionEvents(connection, myIP, false);
        }

        function setupConnectionEvents(connection, myIP, isInitiator) {
            conn = connection;

            conn.on('open', () => {
                // Handshake Verification
                const partnerIP = conn.metadata?.ip;
                
                // STRICT CHECK: Reject if IPs don't match (and neither is unknown)
                if(partnerIP && myIP && partnerIP !== "unknown" && myIP !== "unknown" && partnerIP !== myIP) {
                    showToast("Security Block: Different Networks", 'error');
                    setTimeout(() => {
                        conn.send({ type: 'error', msg: 'Network Mismatch' });
                        conn.close();
                        resetUI();
                    }, 500);
                    return;
                }

                // Success
                els.loader.classList.add('hidden');
                switchToDashboard(conn.peer);
                showToast("Secure Connection Established", 'success');
            });

            conn.on('data', processData);
            
            conn.on('close', () => {
                showToast("Partner Disconnected", 'normal');
                setTimeout(() => location.reload(), 1500);
            });

            conn.on('error', () => {
                showToast("Connection Lost", 'error');
                resetUI();
            });
        }

        function switchToDashboard(partnerId) {
            els.views.home.classList.add('hidden');
            els.views.dash.classList.remove('hidden');
            els.dashPartner.innerText = `ID: ${partnerId}`;
        }

        function resetUI() {
            els.loader.classList.add('hidden');
            conn = null;
        }

        function disconnect() {
            if(conn) conn.close();
            location.reload();
        }

        // --- 5. FILE TRANSFER LOGIC ---

        function triggerFileSelect() { document.getElementById('file-input').click(); }

        function handleFileSelect(input) {
            const files = Array.from(input.files);
            if(!files.length) return;
            els.transferBox.classList.remove('hidden');
            files.forEach(startUpload);
            input.value = ''; 
        }

        // A. UPLOAD
        async function startUpload(file) {
            const txId = Date.now() + Math.random().toString(36).substr(2, 5);
            createFileRow(txId, file.name, file.size, 'up');

            conn.send({ type: 'header', id: txId, name: file.name, size: file.size });

            let offset = 0;
            const CHUNK = 64 * 1024; 
            const reader = new FileReader();
            let isCancelled = false;

            activeTransfers[txId] = {
                cancel: () => {
                    isCancelled = true;
                    conn.send({ type: 'cancel', id: txId });
                    removeFileRow(txId);
                    showToast("Transfer Cancelled", 'normal');
                }
            };

            let lastUpdate = Date.now();
            let bytesSince = 0;

            reader.onload = async (e) => {
                if(isCancelled || !conn) return;
                const chunk = e.target.result;

                // Backpressure
                while(conn.dataChannel.bufferedAmount > 15 * 1024 * 1024) {
                    await new Promise(r => setTimeout(r, 10));
                }

                conn.send({ type: 'chunk', id: txId, data: chunk });
                offset += chunk.byteLength;
                bytesSince += chunk.byteLength;

                const now = Date.now();
                if(now - lastUpdate > 500) {
                    const speed = (bytesSince / 1024 / 1024) / ((now - lastUpdate) / 1000);
                    updateRow(txId, offset, file.size);
                    els.speed.innerText = speed.toFixed(1) + " MB/s";
                    lastUpdate = now;
                    bytesSince = 0;
                }

                if(offset < file.size) {
                    readNext();
                } else {
                    completeTransfer(txId);
                }
            };

            const readNext = () => reader.readAsArrayBuffer(file.slice(offset, offset + CHUNK));
            readNext();
        }

        // B. DOWNLOAD
        function processData(data) {
            if(data.type === 'error') {
                showToast(data.msg, 'error');
                return;
            }

            if(data.type === 'header') {
                els.transferBox.classList.remove('hidden');
                createFileRow(data.id, data.name, data.size, 'down');
                
                const fileStream = streamSaver.createWriteStream(data.name, { size: data.size });
                const writer = fileStream.getWriter();

                activeTransfers[data.id] = {
                    writer: writer,
                    received: 0,
                    size: data.size,
                    lastUpdate: Date.now(),
                    bytesSince: 0,
                    cancel: () => {
                        writer.abort();
                        conn.send({ type: 'cancel', id: data.id });
                        removeFileRow(data.id);
                        showToast("Transfer Cancelled", 'normal');
                    }
                };
            }
            else if(data.type === 'chunk') {
                const session = activeTransfers[data.id];
                if(session && session.writer) {
                    const arr = new Uint8Array(data.data);
                    session.writer.write(arr);
                    session.received += arr.length;
                    session.bytesSince += arr.length;

                    const now = Date.now();
                    if(now - session.lastUpdate > 500) {
                        const speed = (session.bytesSince / 1024 / 1024) / ((now - session.lastUpdate) / 1000);
                        updateRow(data.id, session.received, session.size);
                        els.speed.innerText = speed.toFixed(1) + " MB/s";
                        session.lastUpdate = now;
                        session.bytesSince = 0;
                    }

                    if(session.received === session.size) {
                        session.writer.close();
                        completeTransfer(data.id);
                    }
                }
            }
            else if(data.type === 'cancel') {
                // Partner cancelled
                if(activeTransfers[data.id]) {
                    if(activeTransfers[data.id].writer) activeTransfers[data.id].writer.abort();
                    removeFileRow(data.id);
                    showToast("Partner Cancelled Transfer", 'normal');
                    delete activeTransfers[data.id];
                }
            }
        }

        // --- 6. UI HELPERS ---

        function createFileRow(id, name, size, type) {
            const tmpl = document.getElementById('file-row-template').content.cloneNode(true);
            const el = tmpl.querySelector('div');
            el.id = `tx-${id}`;
            el.querySelector('.file-name').innerText = name;
            el.querySelector('.file-size').innerText = formatBytes(size);
            
            // Icon Color
            const ico = el.querySelector('.file-icon');
            if(type === 'up') ico.classList.add('text-indigo-400');
            else ico.classList.add('text-emerald-400');

            // Cancel Binding
            el.querySelector('.btn-cancel').onclick = () => {
                if(activeTransfers[id]) activeTransfers[id].cancel();
            };

            els.fileList.prepend(el);
            lucide.createIcons();
        }

        function updateRow(id, current, total) {
            const el = document.getElementById(`tx-${id}`);
            if(!el) return;
            const pct = ((current / total) * 100).toFixed(0) + "%";
            el.querySelector('.progress-bar').style.width = pct;
        }

        function completeTransfer(id) {
            const el = document.getElementById(`tx-${id}`);
            if(!el) return;
            el.querySelector('.progress-bar').classList.add('bg-emerald-500');
            el.querySelector('.file-size').innerText = "Completed";
            el.querySelector('.file-size').classList.add('text-emerald-400');
            el.querySelector('.btn-cancel').remove();
            delete activeTransfers[id];
            els.speed.innerText = "0.0 MB/s";
        }

        function removeFileRow(id) {
            const el = document.getElementById(`tx-${id}`);
            if(el) el.remove();
            // Hide box if empty
            if(els.fileList.children.length === 0) els.transferBox.classList.add('hidden');
            els.speed.innerText = "0.0 MB/s";
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function copyCode() {
            navigator.clipboard.writeText(myCode);
            showToast("ID Copied to Clipboard", 'success');
        }
    </script>
</body>
</html>
