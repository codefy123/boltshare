<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashShare Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>

    <style>
        /* Modern Glass Effect */
        .glass { 
            background: rgba(17, 24, 39, 0.7); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }
        
        /* Gradient Animation for Progress */
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .animate-shimmer {
            background: linear-gradient(90deg, #8b5cf6 25%, #a78bfa 50%, #8b5cf6 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        /* Mobile Adjustments */
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen font-sans flex flex-col selection:bg-purple-500 selection:text-white pb-10">

    <nav class="p-4 border-b border-gray-800 bg-gray-900/80 sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-purple-600 p-1.5 rounded-lg">
                    <i data-lucide="zap" class="w-5 h-5 text-white"></i>
                </div>
                <span class="font-bold text-lg tracking-tight hidden sm:block">FlashShare</span>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider">Your Code</p>
                    <p class="font-mono font-bold text-purple-400 text-lg leading-none" id="my-code">...</p>
                </div>
                <div class="sm:hidden bg-gray-800 px-3 py-1 rounded-lg border border-gray-700">
                    <span class="text-xs text-gray-400">Code:</span>
                    <span class="font-mono font-bold text-purple-400 ml-1" id="my-code-mobile">...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-6xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">
        
        <div class="lg:col-span-1 space-y-4">
            <div class="glass rounded-2xl p-5 shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-200 flex items-center gap-2">
                        <i data-lucide="link" class="w-4 h-4 text-purple-400"></i> Connect
                    </h2>
                    <div id="connection-status" class="text-xs px-2 py-1 rounded-full bg-red-500/10 text-red-400 flex items-center gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> Offline
                    </div>
                </div>

                <div id="connect-form" class="space-y-3">
                    <input type="text" id="partner-code" placeholder="Enter 4-Digit Code" maxlength="4"
                        class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-center tracking-[0.5em] font-mono text-lg uppercase focus:border-purple-500 focus:outline-none transition-all placeholder:tracking-normal placeholder:normal-case placeholder:text-sm">
                    
                    <button onclick="connectToPeer()" id="btn-connect"
                        class="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200 active:scale-95 transition-all flex justify-center items-center gap-2">
                        Pair Devices
                    </button>
                </div>

                <div id="connected-info" class="hidden text-center py-2">
                    <p class="text-sm text-gray-400">Connected to:</p>
                    <p class="text-lg font-bold text-white mb-3" id="partner-name">Unknown</p>
                    <button onclick="disconnect()" class="text-xs text-red-400 border border-red-500/30 px-3 py-1.5 rounded-lg hover:bg-red-500/10">
                        Disconnect
                    </button>
                </div>
            </div>

            <div class="glass rounded-xl p-4 flex items-start gap-3 border-l-4 border-l-blue-500">
                <i data-lucide="wifi" class="w-5 h-5 text-blue-400 shrink-0 mt-0.5"></i>
                <div>
                    <p class="text-xs font-bold text-blue-100">Speed Tip</p>
                    <p class="text-[11px] text-gray-400 leading-tight mt-1">
                        Connect both devices to <span class="text-white font-bold">5GHz WiFi</span> or the same <span class="text-white font-bold">5GHz Hotspot</span> for speeds up to 50MB/s.
                    </p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 flex flex-col gap-4">
            
            <div onclick="triggerFileSelect()" class="glass rounded-2xl p-8 border-2 border-dashed border-gray-700 hover:border-purple-500/50 cursor-pointer group text-center transition-all active:bg-gray-800/50">
                <input type="file" id="file-input" class="hidden" multiple onchange="handleFileSelect(this)">
                
                <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform shadow-lg shadow-black/40">
                    <i data-lucide="upload-cloud" class="w-8 h-8 text-purple-500"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-100">Tap to Send Files</h3>
                <p class="text-sm text-gray-500 mt-1">Select multiple files • Photos • Videos</p>
            </div>

            <div class="glass rounded-2xl flex-1 overflow-hidden min-h-[300px] flex flex-col">
                <div class="p-4 border-b border-gray-800 bg-gray-900/50 flex justify-between items-center sticky top-0 backdrop-blur-sm z-10">
                    <h3 class="font-bold text-gray-300 text-sm uppercase tracking-wide">Activity</h3>
                    <span id="speed-indicator" class="text-xs font-mono text-purple-400">0.0 MB/s</span>
                </div>
                
                <div id="file-list" class="p-4 space-y-3 overflow-y-auto max-h-[500px]">
                    <div id="empty-state" class="flex flex-col items-center justify-center py-12 opacity-40">
                        <i data-lucide="inbox" class="w-12 h-12 mb-3 text-gray-500"></i>
                        <p class="text-sm text-gray-500">Transfers will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-auto py-6 text-center border-t border-gray-900">
        <p class="text-sm text-gray-500">
            Created by 
            <a href="https://www.linkedin.com/in/tauqeer-alam/" target="_blank" class="text-purple-400 hover:text-purple-300 font-bold hover:underline transition-all">
                Tauqeer Alam
            </a>
        </p>
    </footer>

    <template id="file-item-template">
        <div class="bg-gray-900/80 rounded-xl p-3 border border-gray-800 flex items-center gap-3 relative overflow-hidden group">
            <div class="w-10 h-10 rounded-lg bg-gray-800 flex items-center justify-center shrink-0">
                <i data-lucide="file" class="w-5 h-5 text-gray-400 icon-type"></i>
            </div>
            
            <div class="flex-1 min-w-0 z-10">
                <div class="flex justify-between items-baseline mb-1">
                    <h4 class="text-sm font-medium text-gray-200 truncate pr-2 file-name">img_2024.jpg</h4>
                    <span class="text-[10px] text-gray-500 file-size">2.4 MB</span>
                </div>
                <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden">
                    <div class="h-full bg-purple-500 w-0 transition-all duration-300 progress-bar"></div>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="text-[10px] text-gray-500 file-status">Waiting...</span>
                    <span class="text-[10px] font-mono text-purple-400 file-percent">0%</span>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- CONFIG ---
        lucide.createIcons();
        
        // --- GLOBAL VARIABLES ---
        const myCode = Math.floor(1000 + Math.random() * 9000).toString(); // Short 4-digit Code
        const myName = "User-" + Math.floor(Math.random() * 1000); // Friendly Name
        
        let peer = null;
        let conn = null;
        let activeTransfers = {}; // Stores progress for multiple files

        // Display My Code
        document.getElementById('my-code').innerText = myCode;
        document.getElementById('my-code-mobile').innerText = myCode;

        // --- 1. PEERJS SETUP ---
        function initPeer() {
            // Using the short code as the Peer ID
            peer = new Peer(myCode);

            peer.on('open', (id) => {
                console.log("My Peer ID:", id);
            });

            peer.on('connection', (connection) => {
                handleConnection(connection);
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    alert("Code collision! Refreshing...");
                    location.reload();
                } else {
                    console.error(err);
                }
            });
        }
        initPeer();

        // --- 2. CONNECT LOGIC ---
        function connectToPeer() {
            const code = document.getElementById('partner-code').value.trim();
            if(code.length !== 4) return alert("Please enter a 4-digit code");
            if(code === myCode) return alert("Cannot connect to yourself");

            const btn = document.getElementById('btn-connect');
            btn.innerText = "Connecting...";
            btn.disabled = true;

            const connection = peer.connect(code, {
                metadata: { name: myName } // Send my name to them
            });
            handleConnection(connection);
        }

        function handleConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                // UI Update
                document.getElementById('connect-form').classList.add('hidden');
                document.getElementById('connected-info').classList.remove('hidden');
                
                // Status Badge
                const badge = document.getElementById('connection-status');
                badge.className = "text-xs px-2 py-1 rounded-full bg-green-500/10 text-green-400 flex items-center gap-1";
                badge.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> Online`;

                // Get Partner Name (if I initiated, it's in metadata. If they initiated, I need to wait for data or assume)
                const partnerName = conn.metadata?.name || "Partner Device";
                document.getElementById('partner-name').innerText = partnerName;
            });

            conn.on('data', processData);
            
            conn.on('close', () => {
                alert("Disconnected");
                location.reload();
            });
        }

        function disconnect() {
            if(conn) conn.close();
            location.reload();
        }

        // --- 3. SEND FILES (MULTIPLE SUPPORT) ---
        const CHUNK_SIZE = 64 * 1024; // 64KB

        function triggerFileSelect() {
            if(!conn) return alert("Please connect to a device first!");
            document.getElementById('file-input').click();
        }

        async function handleFileSelect(input) {
            const files = input.files;
            if (files.length === 0) return;

            // Hide Empty State
            document.getElementById('empty-state').classList.add('hidden');

            // Loop through all selected files
            for (let i = 0; i < files.length; i++) {
                sendFile(files[i]);
            }
            
            // Reset input so same files can be selected again if needed
            input.value = ''; 
        }

        async function sendFile(file) {
            const transferId = Date.now() + Math.random().toString(); // Unique ID
            
            // 1. Create UI
            createFileItem(transferId, file.name, file.size, 'upload');

            // 2. Send Header
            conn.send({
                type: 'header',
                id: transferId,
                name: file.name,
                size: file.size,
                mime: file.type
            });

            // 3. Read & Send
            const reader = new FileReader();
            let offset = 0;
            
            // Speed Calculation vars
            let lastUpdate = Date.now();
            let bytesSinceUpdate = 0;

            reader.onload = async (e) => {
                if(!conn) return;
                const chunk = e.target.result;

                // Backpressure (Prevent crash)
                while (conn.dataChannel.bufferedAmount > 10 * 1024 * 1024) {
                    await new Promise(r => setTimeout(r, 10));
                }

                conn.send({
                    type: 'chunk',
                    id: transferId,
                    data: chunk
                });

                offset += chunk.byteLength;
                bytesSinceUpdate += chunk.byteLength;

                // Update UI every 200ms
                const now = Date.now();
                if (now - lastUpdate > 200) {
                    const speed = (bytesSinceUpdate / 1024 / 1024) / ((now - lastUpdate) / 1000);
                    updateFileItem(transferId, offset, file.size, speed);
                    document.getElementById('speed-indicator').innerText = speed.toFixed(1) + " MB/s";
                    lastUpdate = now;
                    bytesSinceUpdate = 0;
                }

                if (offset < file.size) {
                    readNext();
                } else {
                    markComplete(transferId);
                    document.getElementById('speed-indicator').innerText = "0.0 MB/s";
                }
            };

            const readNext = () => {
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };
            readNext();
        }

        // --- 4. RECEIVE FILES ---
        let downloads = {}; // Store active downloads by ID

        function processData(data) {
            // A. HEADER
            if (data.type === 'header') {
                document.getElementById('empty-state').classList.add('hidden');
                createFileItem(data.id, data.name, data.size, 'download');
                
                const fileStream = streamSaver.createWriteStream(data.name, { size: data.size });
                downloads[data.id] = {
                    writer: fileStream.getWriter(),
                    received: 0,
                    size: data.size,
                    lastUpdate: Date.now(),
                    bytesSinceUpdate: 0
                };
            }
            // B. CHUNK
            else if (data.type === 'chunk') {
                const session = downloads[data.id];
                if (session && session.writer) {
                    const array = new Uint8Array(data.data);
                    session.writer.write(array);
                    session.received += array.length;
                    session.bytesSinceUpdate += array.length;

                    // Update UI
                    const now = Date.now();
                    if (now - session.lastUpdate > 200) {
                        const speed = (session.bytesSinceUpdate / 1024 / 1024) / ((now - session.lastUpdate) / 1000);
                        updateFileItem(data.id, session.received, session.size, speed);
                        document.getElementById('speed-indicator').innerText = speed.toFixed(1) + " MB/s";
                        session.lastUpdate = now;
                        session.bytesSinceUpdate = 0;
                    }

                    if (session.received === session.size) {
                        session.writer.close();
                        delete downloads[data.id];
                        markComplete(data.id);
                        document.getElementById('speed-indicator').innerText = "0.0 MB/s";
                    }
                }
            }
        }

        // --- 5. UI HELPERS ---
        function createFileItem(id, name, size, type) {
            const template = document.getElementById('file-item-template').content.cloneNode(true);
            const el = template.querySelector('div');
            el.id = `file-${id}`;
            
            el.querySelector('.file-name').innerText = name;
            el.querySelector('.file-size').innerText = formatBytes(size);
            
            const icon = type === 'upload' ? 'arrow-up-right' : 'arrow-down-left';
            const iconClass = type === 'upload' ? 'text-blue-400' : 'text-green-400';
            
            // Fix Icon
            const iconContainer = el.querySelector('.icon-type');
            iconContainer.setAttribute('data-lucide', icon);
            iconContainer.classList.add(iconClass);
            
            document.getElementById('file-list').prepend(el);
            lucide.createIcons();
        }

        function updateFileItem(id, current, total, speed) {
            const el = document.getElementById(`file-${id}`);
            if(!el) return;
            
            const pct = ((current / total) * 100).toFixed(0);
            el.querySelector('.progress-bar').style.width = `${pct}%`;
            el.querySelector('.file-percent').innerText = `${pct}%`;
            el.querySelector('.file-status').innerText = `${speed.toFixed(1)} MB/s`;
            
            // Add gradient animation when moving
            el.querySelector('.progress-bar').classList.add('animate-shimmer');
        }

        function markComplete(id) {
            const el = document.getElementById(`file-${id}`);
            if(!el) return;
            
            el.querySelector('.progress-bar').classList.remove('bg-purple-500', 'animate-shimmer');
            el.querySelector('.progress-bar').classList.add('bg-green-500');
            el.querySelector('.file-status').innerText = "Completed";
            el.querySelector('.file-status').classList.add('text-green-500');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
