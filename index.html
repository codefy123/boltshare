<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashShare | Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #0b0f19; --glass: rgba(20, 25, 40, 0.9); --primary: #3b82f6; }
        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: #e2e8f0; height: 100vh; overflow: hidden; }
        
        /* Views & Transitions */
        .view { position: absolute; inset: 0; display: flex; flex-direction: column; transition: opacity 0.3s ease, transform 0.3s ease; padding: 20px; box-sizing: border-box; }
        .hidden-view { opacity: 0; pointer-events: none; transform: scale(0.98); }
        
        .glass { background: var(--glass); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); }
        
        /* File Row Animation */
        .file-row { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-left: 3px solid transparent; }
        .row-active { background: rgba(59, 130, 246, 0.15); border-left-color: var(--primary); }
        .row-done { border-left-color: #10b981; opacity: 0.8; }
        .row-cancelled { border-left-color: #ef4444; opacity: 0.6; }

        /* Toast */
        #toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { pointer-events: auto; background: #1e293b; color: white; padding: 12px 16px; rounded-xl; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.4); animation: slideIn 0.3s ease forwards; display: flex; items-center; gap: 10px; border: 1px solid rgba(255,255,255,0.1); }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="toast-box"></div>

    <section id="view-connect" class="view justify-center items-center z-20">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <div class="inline-block p-3 rounded-full bg-blue-500/10 mb-4 ring-1 ring-blue-500/20">
                    <i data-lucide="rocket" class="w-8 h-8 text-blue-500"></i>
                </div>
                <h1 class="text-4xl font-bold text-white tracking-tight">FlashShare</h1>
                <p class="text-slate-500 text-sm mt-2 font-medium">Ultra-Fast Local Transfer</p>
            </div>

            <div class="glass rounded-2xl p-6 space-y-6 shadow-2xl">
                <div class="bg-slate-900/50 p-4 rounded-xl border border-white/5 text-center group cursor-pointer hover:bg-slate-800/50 transition-colors" onclick="copyId()">
                    <p class="text-[10px] uppercase font-bold text-slate-500 mb-1 tracking-widest">Your Device ID</p>
                    <div class="flex items-center justify-center gap-2">
                        <span id="my-id" class="text-3xl font-mono font-bold text-white tracking-wider group-hover:text-blue-400 transition-colors">...</span>
                        <i data-lucide="copy" class="w-4 h-4 text-slate-600"></i>
                    </div>
                </div>

                <div class="relative">
                    <input type="tel" id="partner-id" maxlength="4" placeholder="ENTER PARTNER ID" 
                        class="w-full bg-slate-950/50 border border-slate-700 focus:border-blue-500 text-white text-center text-xl font-mono font-bold py-4 rounded-xl outline-none transition-all placeholder:text-slate-700 tracking-widest">
                </div>
                
                <button onclick="connect()" id="btn-conn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-blue-600/20 active:scale-[0.98] flex items-center justify-center gap-2">
                    <span>Connect Now</span>
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </section>

    <section id="view-transfer" class="view hidden-view z-10">
        
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                    <i data-lucide="wifi" class="w-5 h-5 text-emerald-400"></i>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-white">Connected</h3>
                    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider" id="conn-type">Optimizing...</p>
                </div>
            </div>
            <button onclick="location.reload()" class="bg-red-500/10 text-red-400 p-2 rounded-lg hover:bg-red-500/20 transition-colors">
                <i data-lucide="power" class="w-5 h-5"></i>
            </button>
        </header>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="glass p-4 rounded-2xl border-t border-white/5">
                <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Queue</p>
                <p class="text-2xl font-mono font-bold text-white" id="queue-count">0</p>
            </div>
            <div class="glass p-4 rounded-2xl border-t border-white/5">
                <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Speed</p>
                <p class="text-2xl font-mono font-bold text-blue-400" id="speed-meter">0.0 MB/s</p>
            </div>
        </div>

        <div class="relative group mb-6">
            <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" multiple onchange="handleFileSelect(this)">
            <div class="glass rounded-2xl border-2 border-dashed border-slate-700 group-hover:border-blue-500 p-6 flex flex-col items-center justify-center gap-2 transition-all group-hover:bg-slate-800/30">
                <div class="bg-blue-600 rounded-full p-3 shadow-lg shadow-blue-600/30 group-hover:scale-110 transition-transform">
                    <i data-lucide="plus" class="w-6 h-6 text-white"></i>
                </div>
                <span class="text-sm font-bold text-slate-300">Tap to Send Files</span>
            </div>
        </div>

        <div class="flex-1 glass rounded-2xl overflow-hidden flex flex-col">
            <div class="px-4 py-3 bg-slate-900/50 border-b border-white/5 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Transfers</span>
            </div>
            <div id="file-list" class="flex-1 overflow-y-auto p-3 space-y-2">
                <div id="empty-state" class="h-full flex flex-col items-center justify-center opacity-30">
                    <i data-lucide="inbox" class="w-10 h-10 mb-3"></i>
                    <p class="text-xs font-medium">No active transfers</p>
                </div>
            </div>
        </div>
    </section>

    <template id="row-tpl">
        <div class="file-row bg-slate-800/40 rounded-xl p-3 relative overflow-hidden mb-2 group">
            <div class="flex items-center gap-3 relative z-10">
                <div class="w-10 h-10 rounded-lg bg-slate-900 flex items-center justify-center shrink-0 border border-slate-700/50">
                    <i data-lucide="file" class="w-5 h-5 text-slate-400 icon-type"></i>
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-bold text-slate-200 truncate pr-2 file-name">Filename.ext</span>
                        <button class="btn-cancel p-1 text-slate-500 hover:text-red-400 transition-colors rounded-full hover:bg-slate-800">
                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="h-1.5 flex-1 bg-slate-900 rounded-full overflow-hidden">
                            <div class="progress-bar h-full bg-blue-500 w-0 transition-all duration-200"></div>
                        </div>
                        <span class="text-[10px] font-mono text-slate-400 file-pct">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- 1. PERFORMANCE CONFIGURATION ---
        const PEER_CONFIG = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ],
            debug: 1
        };

        // AGGRESSIVE TUNING FOR 5GHz
        const CHUNK_SIZE = 256 * 1024; // 256KB Chunks (Larger = Less CPU Overhead)
        const BUFFER_HIGH_WATER = 16 * 1024 * 1024; // 16MB Buffer
        const BUFFER_LOW_WATER = 2 * 1024 * 1024;   // Resume reading at 2MB

        lucide.createIcons();
        const myId = Math.floor(1000 + Math.random() * 9000).toString();
        document.getElementById('my-id').innerText = myId;

        let peer, conn;
        let transferQueue = [];
        let isProcessing = false;
        let currentTask = null; // The active transfer object

        // --- 2. NETWORK CORE ---
        function initPeer() {
            peer = new Peer(myId, PEER_CONFIG);
            
            peer.on('open', id => console.log('My ID:', id));
            
            peer.on('connection', c => {
                handleConnection(c);
            });
            
            peer.on('error', err => {
                console.error(err);
                showToast('Connection Error. Retry.', 'error');
            });
        }
        initPeer();

        function connect() {
            const pid = document.getElementById('partner-id').value.trim();
            if(pid.length !== 4) return showToast("Invalid ID", 'error');
            
            const btn = document.getElementById('btn-conn');
            btn.innerHTML = `<span class="animate-spin">‚è≥</span> Connecting...`;
            
            const c = peer.connect(pid, { reliable: true });
            handleConnection(c);
        }

        function handleConnection(c) {
            conn = c;
            
            conn.on('open', () => {
                switchView('view-transfer');
                detectConnectionType();
            });

            conn.on('data', (data) => {
                if(data instanceof ArrayBuffer || data instanceof Uint8Array) {
                    handleBinaryData(data);
                } else {
                    handleControlMessage(data);
                }
            });

            conn.on('close', () => {
                showToast("Partner Disconnected", 'error');
                setTimeout(() => location.reload(), 2000);
            });
        }

        // --- 3. QUEUE & TRANSFER LOGIC ---

        function handleFileSelect(input) {
            const files = Array.from(input.files);
            if(!files.length) return;
            document.getElementById('empty-state').classList.add('hidden');

            files.forEach(file => {
                const id = Date.now() + Math.random().toString(36).substr(2,4);
                createRow(id, file.name, 'up');
                
                transferQueue.push({
                    id, file, 
                    type: 'upload', 
                    name: file.name, 
                    size: file.size,
                    status: 'pending'
                });
            });

            input.value = '';
            updateQueueUI();
            processQueue();
        }

        async function processQueue() {
            if(isProcessing || transferQueue.length === 0) return;
            
            const task = transferQueue.find(t => t.status === 'pending');
            if(!task) return;

            isProcessing = true;
            currentTask = task;
            task.status = 'active';
            
            updateRowStatus(task.id, 'active');

            try {
                if(task.type === 'upload') {
                    await uploadFile(task);
                } else {
                    // Downloads are passive, waiting for data.
                    // However, we mark them active in UI here.
                }
            } catch(e) {
                console.error(e);
                if(task.status !== 'cancelled') updateRowStatus(task.id, 'error');
            }

            // If we finished successfully or errored (not cancelled mid-way)
            if(task.status !== 'cancelled') {
                isProcessing = false;
                currentTask = null;
                updateQueueUI();
                processQueue(); // Next
            }
        }

        // --- 4. UPLOAD ENGINE (SENDER) ---
        async function uploadFile(task) {
            return new Promise(async (resolve, reject) => {
                conn.send({ type: 'header', id: task.id, name: task.name, size: task.size });
                
                const reader = new FileReader();
                let offset = 0;
                let lastTime = Date.now();
                let bytesSince = 0;

                // Cancellation Hook
                task.cancel = () => {
                    reader.abort();
                    conn.send({ type: 'cancel', id: task.id });
                    task.status = 'cancelled';
                    updateRowStatus(task.id, 'cancelled');
                    resolve(); // Resolve to move to next
                };

                const readNext = () => {
                    if(task.status === 'cancelled') return;
                    const slice = task.file.slice(offset, offset + CHUNK_SIZE);
                    reader.readAsArrayBuffer(slice);
                };

                reader.onload = async (e) => {
                    if(task.status === 'cancelled') return;
                    
                    // Backpressure
                    if(conn.dataChannel.bufferedAmount > BUFFER_HIGH_WATER) {
                        await waitForDrain();
                    }

                    conn.send(e.target.result);
                    
                    offset += e.target.result.byteLength;
                    bytesSince += e.target.result.byteLength;

                    // Speed UI (Throttled 300ms)
                    const now = Date.now();
                    if(now - lastTime > 300) {
                        const mbps = (bytesSince / 1024 / 1024) / ((now - lastTime) / 1000);
                        document.getElementById('speed-meter').innerText = mbps.toFixed(1) + " MB/s";
                        updateProgress(task.id, offset, task.size);
                        lastTime = now;
                        bytesSince = 0;
                    }

                    if(offset < task.size) {
                        readNext();
                    } else {
                        conn.send({ type: 'end', id: task.id });
                        task.status = 'done';
                        updateRowStatus(task.id, 'done');
                        document.getElementById('speed-meter').innerText = "0.0 MB/s";
                        resolve();
                    }
                };

                readNext();
            });
        }

        // --- 5. DOWNLOAD ENGINE (RECEIVER) ---
        async function handleControlMessage(msg) {
            if(msg.type === 'header') {
                // New Incoming File
                document.getElementById('empty-state').classList.add('hidden');
                createRow(msg.id, msg.name, 'down');
                
                // Create Task
                const task = {
                    id: msg.id, 
                    type: 'download', 
                    name: msg.name, 
                    size: msg.size,
                    status: 'active',
                    received: 0,
                    lastTime: Date.now(),
                    bytesSince: 0
                };
                
                // StreamSaver
                const fileStream = streamSaver.createWriteStream(msg.name, { size: msg.size });
                task.writer = fileStream.getWriter();

                // Cancellation Hook
                task.cancel = () => {
                    task.writer.abort();
                    conn.send({ type: 'cancel', id: task.id });
                    task.status = 'cancelled';
                    updateRowStatus(task.id, 'cancelled');
                    currentTask = null;
                    isProcessing = false;
                };

                currentTask = task;
                isProcessing = true;
                updateRowStatus(msg.id, 'active');
            }
            else if(msg.type === 'end') {
                if(currentTask && currentTask.id === msg.id) {
                    currentTask.writer.close();
                    currentTask.status = 'done';
                    updateRowStatus(msg.id, 'done');
                    document.getElementById('speed-meter').innerText = "0.0 MB/s";
                    currentTask = null;
                    isProcessing = false;
                }
            }
            else if(msg.type === 'cancel') {
                // Partner clicked cancel
                if(currentTask && currentTask.id === msg.id) {
                    if(currentTask.type === 'upload') {
                        // I am uploader, partner cancelled
                        currentTask.status = 'cancelled'; // Reader loop will stop
                        updateRowStatus(msg.id, 'cancelled');
                    } else {
                        // I am downloader, partner cancelled
                        currentTask.writer.abort();
                        currentTask.status = 'cancelled';
                        updateRowStatus(msg.id, 'cancelled');
                    }
                    currentTask = null;
                    isProcessing = false;
                    processQueue(); // Resume queue
                }
            }
        }

        function handleBinaryData(data) {
            if(!currentTask || currentTask.type !== 'download' || currentTask.status === 'cancelled') return;
            
            const arr = new Uint8Array(data);
            currentTask.writer.write(arr);
            
            currentTask.received += arr.length;
            currentTask.bytesSince += arr.length;

            const now = Date.now();
            if(now - currentTask.lastTime > 300) {
                const mbps = (currentTask.bytesSince / 1024 / 1024) / ((now - currentTask.lastTime) / 1000);
                document.getElementById('speed-meter').innerText = mbps.toFixed(1) + " MB/s";
                updateProgress(currentTask.id, currentTask.received, currentTask.size);
                currentTask.lastTime = now;
                currentTask.bytesSince = 0;
            }
        }

        // --- UTILS & UI ---
        
        function waitForDrain() {
            return new Promise(r => {
                const i = setInterval(() => {
                    if(conn.dataChannel.bufferedAmount < BUFFER_LOW_WATER) {
                        clearInterval(i);
                        r();
                    }
                }, 5);
            });
        }

        function createRow(id, name, type) {
            const tpl = document.getElementById('row-tpl').content.cloneNode(true);
            const row = tpl.querySelector('.file-row');
            row.id = `row-${id}`;
            row.querySelector('.file-name').innerText = name;
            
            const icon = row.querySelector('.icon-type');
            if(type === 'up') icon.classList.add('text-blue-400');
            else icon.classList.add('text-emerald-400');

            // CANCEL CLICK
            row.querySelector('.btn-cancel').onclick = () => {
                if(currentTask && currentTask.id === id) {
                    currentTask.cancel();
                } else {
                    // Cancel pending item from queue
                    const idx = transferQueue.findIndex(t => t.id === id);
                    if(idx > -1) {
                        transferQueue.splice(idx, 1);
                        row.remove();
                        updateQueueUI();
                    }
                }
            };

            document.getElementById('file-list').appendChild(row);
            lucide.createIcons();
        }

        function updateRowStatus(id, status) {
            const row = document.getElementById(`row-${id}`);
            if(!row) return;
            
            row.className = 'file-row bg-slate-800/40 rounded-xl p-3 relative overflow-hidden mb-2 group'; // Reset
            
            if(status === 'active') row.classList.add('row-active');
            else if(status === 'done') {
                row.classList.add('row-done');
                row.querySelector('.btn-cancel').remove();
                row.querySelector('.file-pct').innerText = "DONE";
                row.querySelector('.file-pct').classList.add('text-emerald-400');
            }
            else if(status === 'cancelled') {
                row.classList.add('row-cancelled');
                row.querySelector('.btn-cancel').remove();
                row.querySelector('.file-pct').innerText = "CANCELLED";
                row.querySelector('.file-pct').classList.add('text-red-400');
            }
        }

        function updateProgress(id, current, total) {
            const row = document.getElementById(`row-${id}`);
            if(row) {
                const p = Math.floor((current/total)*100);
                row.querySelector('.progress-bar').style.width = `${p}%`;
                row.querySelector('.file-pct').innerText = `${p}%`;
            }
        }

        function updateQueueUI() {
            const pending = transferQueue.filter(t => t.status === 'pending').length;
            document.getElementById('queue-count').innerText = pending;
        }

        function detectConnectionType() {
            // Rough heuristic: if connection is immediate, likely local.
            setTimeout(() => {
                const label = document.getElementById('conn-type');
                // We can't query ICE state easily in basic PeerJS without digging into internals
                // But we can show we are ready.
                label.innerText = "DIRECT P2P (Ready)"; 
                label.classList.add('text-emerald-400');
            }, 500);
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            showToast("ID Copied", 'success');
        }

        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden-view'));
            document.getElementById(id).classList.remove('hidden-view');
        }

        function showToast(msg, type='normal') {
            const t = document.createElement('div');
            t.className = `toast`;
            if(type==='error') t.style.borderColor = '#ef4444';
            t.innerHTML = `<i data-lucide="${type==='error'?'alert-circle':'check-circle'}" class="w-4 h-4 ${type==='error'?'text-red-400':'text-emerald-400'}"></i> ${msg}`;
            document.getElementById('toast-box').appendChild(t);
            lucide.createIcons();
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
