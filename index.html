<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashShare | Ludicrous Speed</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #000000; --panel: #0a0a0a; --primary: #00ff9d; --err: #ff0055; }
        body { font-family: 'Chakra Petch', sans-serif; background: var(--bg); color: #e0e0e0; height: 100vh; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Performance UI */
        .glass { background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .view { position: absolute; inset: 0; display: flex; flex-direction: column; transition: opacity 0.3s; padding: 20px; }
        .hidden-view { opacity: 0; pointer-events: none; z-index: -1; }

        /* Speed Bars */
        .bar-container { background: #1a1a1a; height: 4px; width: 100%; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s linear; box-shadow: 0 0 10px var(--primary); }
        
        /* Toast */
        .toast { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="toast-area" class="fixed bottom-6 left-0 w-full z-50 flex flex-col items-center gap-2 pointer-events-none"></div>

    <section id="view-connect" class="view justify-center items-center z-20">
        <div class="w-full max-w-sm space-y-8">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-white tracking-tighter mb-2 italic">FLASHSHARE <span class="text-[#00ff9d]">MAX</span></h1>
                <p class="text-xs font-mono text-gray-500">ENGINE: LUDICROUS MODE (512KB)</p>
            </div>

            <div class="glass rounded-none p-8 border-l-4 border-[#00ff9d] space-y-6">
                <div class="cursor-pointer group" onclick="copyId()">
                    <p class="text-[10px] font-mono text-gray-500 mb-1">THIS DEVICE ID</p>
                    <div class="flex items-center justify-between bg-black p-3 border border-gray-800 hover:border-[#00ff9d] transition-colors">
                        <span id="my-id" class="text-3xl font-mono font-bold text-white tracking-widest">...</span>
                        <i data-lucide="copy" class="w-4 h-4 text-gray-600 group-hover:text-[#00ff9d]"></i>
                    </div>
                </div>

                <div class="space-y-4">
                    <input type="tel" id="partner-id" maxlength="4" placeholder="PARTNER ID" 
                        class="w-full bg-black border border-gray-800 focus:border-[#00ff9d] text-white text-center text-2xl font-mono font-bold py-4 outline-none transition-all placeholder:text-gray-800">
                    
                    <button onclick="connect()" id="btn-conn" class="w-full bg-[#00ff9d] hover:bg-[#00cc7d] text-black font-bold py-4 text-lg active:scale-[0.98] transition-all">
                        INITIATE LINK
                    </button>
                </div>
            </div>
            
            <div class="text-center">
                <p class="text-[10px] text-gray-500 font-mono" id="net-status">NETWORK: WAITING...</p>
            </div>
        </div>
    </section>

    <section id="view-dash" class="view hidden-view z-10">
        <header class="flex justify-between items-end mb-8 border-b border-gray-800 pb-4">
            <div>
                <h2 class="text-xl font-bold italic tracking-tighter">CONNECTED</h2>
                <div class="flex items-center gap-2 mt-1">
                    <div class="w-2 h-2 bg-[#00ff9d] rounded-full animate-pulse"></div>
                    <p class="text-[10px] font-mono text-[#00ff9d]">DIRECT P2P ENCRYPTED</p>
                </div>
            </div>
            <button onclick="endSession()" class="text-xs font-mono text-red-500 hover:text-red-400 border border-red-900/50 px-3 py-1 bg-red-950/20">
                ABORT
            </button>
        </header>

        <div class="mb-8">
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs font-mono text-gray-500">THROUGHPUT</span>
                <span id="status-badge" class="text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 font-bold">IDLE</span>
            </div>
            <div class="text-6xl font-mono font-bold text-white tracking-tighter" id="speed-meter">
                0.0 <span class="text-lg text-gray-600">MB/s</span>
            </div>
        </div>

        <div class="relative group mb-6">
            <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" multiple onchange="handleFiles(this)">
            <div class="border-2 border-dashed border-gray-800 group-hover:border-[#00ff9d] h-24 flex items-center justify-center gap-4 transition-all bg-gray-900/20">
                <i data-lucide="plus-square" class="w-6 h-6 text-gray-500 group-hover:text-[#00ff9d]"></i>
                <span class="text-sm font-bold text-gray-400 group-hover:text-white">ADD FILES TO QUEUE</span>
            </div>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-[10px] font-mono text-gray-500">QUEUE</span>
                <span class="text-[10px] font-mono text-gray-500" id="queue-count">0 ITEMS</span>
            </div>
            
            <div id="file-list" class="flex-1 overflow-y-auto space-y-1 pr-1">
                <div id="empty-state" class="h-full flex flex-col items-center justify-center opacity-20">
                    <i data-lucide="activity" class="w-12 h-12 mb-2"></i>
                    <p class="text-xs font-mono">SYSTEM READY</p>
                </div>
            </div>
        </div>
    </section>

    <template id="tpl-row">
        <div class="row bg-[#0a0a0a] border border-gray-800 p-3 mb-1 relative group">
            <div class="flex justify-between items-center relative z-10 mb-2">
                <div class="flex items-center gap-3 overflow-hidden">
                    <i data-lucide="file" class="w-4 h-4 text-gray-600 shrink-0 icon-type"></i>
                    <span class="text-xs font-bold font-mono text-gray-300 truncate file-name">FILENAME</span>
                </div>
                <button class="btn-cancel text-gray-600 hover:text-[#ff0055]">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="bar-container">
                <div class="bar-fill"></div>
            </div>
            <div class="flex justify-between mt-1">
                <span class="text-[10px] font-mono text-gray-600 file-size">0 MB</span>
                <span class="text-[10px] font-mono text-gray-500 file-pct">0%</span>
            </div>
        </div>
    </template>

    <script>
        // --- 1. ENGINE CONFIGURATION (LUDICROUS MODE) ---
        
        // 512KB Chunks: The sweet spot for 5GHz WiFi.
        // Too small (16KB) = High CPU overhead = Slow.
        // Too big (16MB) = Memory spikes = Crash.
        const CHUNK_SIZE = 512 * 1024; 
        
        // 64MB Buffer: Aggressive pre-loading to ensure the radio never idles.
        const BUFFER_HIGH = 64 * 1024 * 1024;
        const BUFFER_LOW = 4 * 1024 * 1024; // Resume reading when buffer drops to 4MB

        const PEER_CFG = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' } // Only basic STUN needed for Hole Punching
            ],
            debug: 0
        };

        lucide.createIcons();
        const myId = Math.floor(1000 + Math.random() * 9000).toString();
        document.getElementById('my-id').innerText = myId;

        // --- GLOBAL STATE ---
        let peer, conn;
        let queue = [];
        let isProcessing = false;
        let currentTask = null;

        // --- 2. CONNECTIVITY ---
        function init() {
            peer = new Peer(myId, PEER_CFG);
            
            peer.on('open', id => {
                document.getElementById('net-status').innerText = "NETWORK: ONLINE (READY)";
                document.getElementById('net-status').classList.add('text-[#00ff9d]');
            });
            
            peer.on('connection', c => handleConn(c));
            
            peer.on('error', err => {
                showToast("CONNECTION ERROR", 'err');
                resetUI();
            });

            window.addEventListener('beforeunload', () => {
                if(conn && conn.open) conn.send({ type: 'bye' });
            });
        }
        init();

        function connect() {
            const pid = document.getElementById('partner-id').value.trim();
            if(pid.length !== 4) return showToast("INVALID ID", 'err');
            
            document.getElementById('btn-conn').innerText = "CONNECTING...";
            const c = peer.connect(pid, { reliable: true });
            handleConn(c);
        }

        function handleConn(c) {
            conn = c;
            conn.on('open', () => {
                showView('view-dash');
                showToast("SECURE CONNECTION ESTABLISHED");
            });
            conn.on('data', d => {
                if(d instanceof ArrayBuffer || d instanceof Uint8Array) handleBinary(d);
                else handleMsg(d);
            });
            conn.on('close', () => handleDisconnect());
            conn.on('error', () => handleDisconnect());
        }

        function handleDisconnect() {
            showToast("CONNECTION LOST", 'err');
            setTimeout(() => location.reload(), 2000);
        }

        function endSession() {
            if(conn) conn.send({ type: 'bye' });
            handleDisconnect();
        }

        // --- 3. QUEUE SYSTEM ---

        function handleFiles(input) {
            const files = Array.from(input.files);
            if(!files.length) return;
            document.getElementById('empty-state').classList.add('hidden');

            files.forEach(f => {
                const id = Math.random().toString(36).substr(2, 6);
                createRow(id, f.name, 'up', f.size);
                queue.push({ id, file: f, type: 'up', name: f.name, size: f.size, status: 'wait' });
            });
            input.value = '';
            updateQueueCount();
            processQueue();
        }

        async function processQueue() {
            if(isProcessing || queue.length === 0) {
                if(queue.length === 0) document.getElementById('status-badge').innerText = "IDLE";
                return;
            }

            const task = queue.find(t => t.status === 'wait');
            if(!task) return;

            isProcessing = true;
            currentTask = task;
            task.status = 'active';
            
            updateRowStatus(task.id, 'active');
            document.getElementById('status-badge').innerText = "TRANSMITTING";
            document.getElementById('status-badge').className = "text-[10px] bg-[#00ff9d] text-black px-2 py-0.5 font-bold animate-pulse";

            try {
                if(task.type === 'up') await uploadEngine(task);
            } catch(e) {
                console.error(e);
                if(task.status !== 'cancelled') updateRowStatus(task.id, 'err');
            }

            resetEngineState();
            processQueue();
        }

        function resetEngineState() {
            isProcessing = false;
            currentTask = null;
            document.getElementById('speed-meter').innerHTML = `0.0 <span class="text-lg text-gray-600">MB/s</span>`;
            document.getElementById('status-badge').innerText = "IDLE";
            document.getElementById('status-badge').className = "text-[10px] bg-gray-800 text-gray-400 px-2 py-0.5 font-bold";
        }

        // --- 4. UPLOAD ENGINE (SENDER) ---
        async function uploadEngine(task) {
            return new Promise((resolve) => {
                conn.send({ type: 'header', id: task.id, name: task.name, size: task.size });

                const reader = new FileReader();
                let offset = 0;
                let lastTime = Date.now();
                let bytesSince = 0;

                task.cancel = () => {
                    reader.abort();
                    conn.send({ type: 'cancel', id: task.id });
                    task.status = 'cancelled';
                    updateRowStatus(task.id, 'cancelled');
                    resolve();
                };

                const readNext = () => {
                    if(task.status === 'cancelled') return;
                    const slice = task.file.slice(offset, offset + CHUNK_SIZE);
                    reader.readAsArrayBuffer(slice);
                };

                reader.onload = async (e) => {
                    if(task.status === 'cancelled') return;

                    // Backpressure Loop
                    if(conn.dataChannel.bufferedAmount > BUFFER_HIGH) {
                        await new Promise(r => {
                            const i = setInterval(() => {
                                if(conn.dataChannel.bufferedAmount < BUFFER_LOW) {
                                    clearInterval(i);
                                    r();
                                }
                            }, 5);
                        });
                    }

                    conn.send(e.target.result);
                    offset += e.target.result.byteLength;
                    bytesSince += e.target.result.byteLength;

                    // UI Throttling (1000ms = 1s) - Save CPU
                    const now = Date.now();
                    if(now - lastTime > 1000) {
                        const mbps = (bytesSince / 1024 / 1024) / ((now - lastTime) / 1000);
                        document.getElementById('speed-meter').innerHTML = `${mbps.toFixed(1)} <span class="text-lg text-gray-600">MB/s</span>`;
                        updateProgress(task.id, offset, task.size);
                        lastTime = now;
                        bytesSince = 0;
                    }

                    if(offset < task.size) {
                        readNext();
                    } else {
                        conn.send({ type: 'end', id: task.id });
                        task.status = 'done';
                        updateRowStatus(task.id, 'done');
                        resolve();
                    }
                };
                readNext();
            });
        }

        // --- 5. RECEIVER ENGINE ---
        
        async function handleMsg(msg) {
            if(msg.type === 'bye') handleDisconnect();
            
            else if(msg.type === 'header') {
                document.getElementById('empty-state').classList.add('hidden');
                createRow(msg.id, msg.name, 'down', msg.size);

                const task = {
                    id: msg.id, type: 'down', name: msg.name, size: msg.size,
                    status: 'active', received: 0, lastTime: Date.now(), bytesSince: 0
                };

                const fileStream = streamSaver.createWriteStream(msg.name, { size: msg.size });
                task.writer = fileStream.getWriter();

                task.cancel = () => {
                    task.writer.abort();
                    conn.send({ type: 'cancel', id: task.id });
                    task.status = 'cancelled';
                    updateRowStatus(task.id, 'cancelled');
                    resetEngineState();
                };

                currentTask = task;
                isProcessing = true;
                updateRowStatus(msg.id, 'active');
                document.getElementById('status-badge').innerText = "RECEIVING";
                document.getElementById('status-badge').className = "text-[10px] bg-[#00ff9d] text-black px-2 py-0.5 font-bold animate-pulse";
            }
            
            else if(msg.type === 'end') {
                if(currentTask && currentTask.id === msg.id) {
                    currentTask.writer.close();
                    updateRowStatus(msg.id, 'done');
                    resetEngineState();
                }
            }
            
            else if(msg.type === 'cancel') {
                if(currentTask && currentTask.id === msg.id) {
                    if(currentTask.type === 'up') currentTask.status = 'cancelled'; 
                    else currentTask.writer.abort();
                    
                    updateRowStatus(msg.id, 'cancelled');
                    resetEngineState();
                    // Sender sync delay
                    setTimeout(processQueue, 500);
                }
            }
        }

        function handleBinary(data) {
            if(!currentTask || currentTask.type !== 'down' || currentTask.status !== 'active') return;

            const arr = new Uint8Array(data);
            currentTask.writer.write(arr);
            currentTask.received += arr.length;
            currentTask.bytesSince += arr.length;

            const now = Date.now();
            if(now - currentTask.lastTime > 1000) {
                const mbps = (currentTask.bytesSince / 1024 / 1024) / ((now - currentTask.lastTime) / 1000);
                document.getElementById('speed-meter').innerHTML = `${mbps.toFixed(1)} <span class="text-lg text-gray-600">MB/s</span>`;
                updateProgress(currentTask.id, currentTask.received, currentTask.size);
                currentTask.lastTime = now;
                currentTask.bytesSince = 0;
            }
        }

        // --- UI UTILS ---

        function createRow(id, name, type, size) {
            const tpl = document.getElementById('tpl-row').content.cloneNode(true);
            const el = tpl.querySelector('.row');
            el.id = `row-${id}`;
            el.querySelector('.file-name').innerText = name;
            el.querySelector('.file-size').innerText = formatBytes(size);
            
            const icon = el.querySelector('.icon-type');
            if(type === 'up') icon.classList.add('text-[#00ff9d]');
            else icon.classList.add('text-blue-400');

            el.querySelector('.btn-cancel').onclick = () => {
                if(currentTask && currentTask.id === id) currentTask.cancel();
                else {
                    const idx = queue.findIndex(t => t.id === id);
                    if(idx > -1) { queue.splice(idx, 1); el.remove(); updateQueueCount(); }
                }
            };

            document.getElementById('file-list').appendChild(el);
            lucide.createIcons();
        }

        function updateProgress(id, curr, total) {
            const el = document.getElementById(`row-${id}`);
            if(el) {
                const pct = Math.floor((curr/total)*100);
                el.querySelector('.bar-fill').style.width = `${pct}%`;
                el.querySelector('.file-pct').innerText = `${pct}%`;
            }
        }

        function updateRowStatus(id, status) {
            const el = document.getElementById(`row-${id}`);
            if(!el) return;
            
            if(status === 'active') {
                el.style.borderColor = '#00ff9d';
                el.style.backgroundColor = 'rgba(0, 255, 157, 0.05)';
            }
            else if(status === 'done') {
                el.style.borderColor = '#333';
                el.style.opacity = '0.5';
                el.querySelector('.bar-fill').style.backgroundColor = '#10b981';
                el.querySelector('.btn-cancel').remove();
            }
            else if(status === 'cancelled') {
                el.style.borderColor = '#ff0055';
                el.style.opacity = '0.5';
                el.querySelector('.bar-fill').style.backgroundColor = '#ff0055';
                el.querySelector('.btn-cancel').remove();
                el.querySelector('.file-name').classList.add('line-through', 'text-red-500');
            }
        }

        function updateQueueCount() {
            document.getElementById('queue-count').innerText = `${queue.length} ITEMS`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024; const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden-view'));
            document.getElementById(id).classList.remove('hidden-view');
        }

        function showToast(msg, type='normal') {
            const t = document.createElement('div');
            t.className = `toast px-4 py-2 rounded font-mono text-xs font-bold text-black pointer-events-auto ${type==='err'?'bg-[#ff0055] text-white':'bg-[#00ff9d]'}`;
            t.innerText = msg;
            document.getElementById('toast-area').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            showToast("ID COPIED");
        }
        
        function resetUI() {
            document.getElementById('btn-conn').innerText = "INITIATE LINK";
        }
    </script>
</body>
</html>
