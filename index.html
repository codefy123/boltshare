<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashShare Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>

    <style>
        .glass { background: rgba(17, 24, 39, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(75, 85, 99, 0.4); }
        .bg-pattern { background-image: radial-gradient(rgba(139, 92, 246, 0.15) 1px, transparent 1px); background-size: 24px 24px; }
        .progress-bar-animated { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen font-sans bg-pattern flex flex-col">

    <div id="speed-tip" class="bg-indigo-900/90 text-indigo-100 px-4 py-2 text-center text-sm flex justify-center items-center gap-4 border-b border-indigo-700">
        <span class="flex items-center gap-2">
            <i data-lucide="wifi" class="w-4 h-4"></i>
            <b>Tip:</b> Switch your Hotspot/WiFi to <b>5GHz Band</b> or <b>WiFi 6</b> for speeds over 20 MB/s.
        </span>
        <button onclick="document.getElementById('speed-tip').remove()" class="hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <nav class="p-4 md:p-6 border-b border-gray-800 bg-gray-900/80 sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2 text-purple-500">
                <div class="p-2 bg-purple-500/10 rounded-lg"><i data-lucide="zap" class="w-6 h-6"></i></div>
                <h1 class="text-xl font-bold text-white tracking-tight">FlashShare <span class="text-xs text-purple-400 font-normal border border-purple-500/30 px-1 rounded">Ultimate</span></h1>
            </div>
            
            <div class="flex items-center gap-3 bg-gray-800/50 p-2 pr-4 rounded-full border border-gray-700">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 flex items-center justify-center font-bold text-xs" id="user-avatar">ME</div>
                <div class="flex flex-col leading-tight">
                    <span class="text-xs text-gray-400">My Username</span>
                    <span class="font-bold text-sm text-purple-300 font-mono" id="my-username">Generating...</span>
                </div>
                <button onclick="copyId()" class="ml-2 p-1.5 hover:bg-gray-700 rounded-full transition-colors text-gray-400 hover:text-white" title="Copy ID">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-6xl mx-auto w-full p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="glass rounded-2xl p-6 shadow-xl">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-200">
                    <i data-lucide="link" class="w-5 h-5 text-purple-400"></i> Pair Devices
                </h2>

                <div id="connection-form" class="space-y-4">
                    <p class="text-sm text-gray-400">Enter the generated username from the other device to connect.</p>
                    <div class="relative">
                        <input type="text" id="partner-id" placeholder="Ex: NEON-TIGER" 
                            class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 pl-10 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition-all font-mono uppercase text-sm">
                        <i data-lucide="user" class="w-4 h-4 text-gray-500 absolute left-3 top-3.5"></i>
                    </div>
                    <button onclick="connectToPeer()" id="connect-btn"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-purple-900/20 flex items-center justify-center gap-2">
                        Connect
                    </button>
                </div>

                <div id="active-connection" class="hidden text-center py-4">
                    <div class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-3 text-green-400 animate-pulse">
                        <i data-lucide="wifi" class="w-8 h-8"></i>
                    </div>
                    <h3 class="font-bold text-green-400">Connected</h3>
                    <p class="text-sm text-gray-400 mb-4">Linked with <span id="partner-name" class="text-white font-mono">...</span></p>
                    <button onclick="location.reload()" class="text-xs text-red-400 hover:text-red-300 underline">Disconnect</button>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 text-center md:text-left">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Transfer Stats</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-900/50 p-3 rounded-xl border border-gray-800">
                        <p class="text-xs text-gray-400">Current Speed</p>
                        <p class="text-xl font-mono font-bold text-blue-400" id="stat-speed">0 MB/s</p>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-xl border border-gray-800">
                        <p class="text-xs text-gray-400">Last File</p>
                        <p class="text-xl font-mono font-bold text-purple-400" id="stat-time">0s</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 flex flex-col gap-6">
            
            <div id="drop-zone" class="glass rounded-2xl p-1 h-64 relative group cursor-pointer transition-all hover:border-purple-500/50" onclick="triggerFileSelect()">
                <div class="absolute inset-0 bg-gray-900/50 rounded-2xl flex flex-col items-center justify-center text-center p-6 transition-colors group-hover:bg-gray-800/50">
                    <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
                    <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-xl shadow-black/50 border border-gray-700">
                        <i data-lucide="upload-cloud" class="w-10 h-10 text-purple-500"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-200">Send Files</h3>
                    <p class="text-gray-400 mt-2">Click or Drag & Drop to Share</p>
                    <span class="mt-4 px-3 py-1 bg-gray-800 rounded-full text-xs text-gray-500 border border-gray-700">Supports 10GB+ sizes</span>
                </div>
            </div>

            <div class="glass rounded-2xl overflow-hidden flex-1 min-h-[300px] flex flex-col">
                <div class="p-4 border-b border-gray-800 bg-gray-900/50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-300 flex items-center gap-2">
                        <i data-lucide="activity" class="w-4 h-4 text-purple-400"></i> Activity
                    </h3>
                    <button onclick="clearHistory()" class="text-xs text-gray-500 hover:text-white">Clear</button>
                </div>
                
                <div id="activity-list" class="p-4 space-y-4 overflow-y-auto max-h-[400px]">
                    <div id="empty-state" class="text-center py-10 opacity-50">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-600"></i>
                        <p class="text-gray-500 text-sm">No transfers yet</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <template id="transfer-item-template">
        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800 relative overflow-hidden group">
            <div class="flex items-center gap-4 relative z-10">
                <div class="transfer-icon-bg w-12 h-12 rounded-lg flex items-center justify-center shrink-0 bg-gray-800">
                    <i data-lucide="file" class="w-6 h-6 text-gray-400"></i>
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between mb-1">
                        <h4 class="font-bold text-sm truncate text-gray-200 transfer-name">filename.ext</h4>
                        <span class="text-xs font-mono text-gray-400 transfer-size">0 MB</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                        <div class="transfer-bar bg-purple-500 h-full w-0 progress-bar-animated"></div>
                    </div>
                    <div class="flex justify-between mt-1 text-xs text-gray-500">
                        <span class="transfer-status">Waiting...</span>
                        <span class="transfer-percent">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- 1. CONFIG & UTILS ---
        lucide.createIcons();
        
        const adjectives = ["NEON", "CYBER", "IRON", "BLUE", "RED", "DARK", "FAST", "MEGA"];
        const animals = ["TIGER", "WOLF", "EAGLE", "HAWK", "BEAR", "LION", "SHARK", "FALCON"];
        
        function generateUsername() {
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const ani = animals[Math.floor(Math.random() * animals.length)];
            const num = Math.floor(Math.random() * 99) + 1; // 1-99
            return `${adj}-${ani}-${num}`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- 2. GLOBAL STATE ---
        let myName = generateUsername();
        document.getElementById('my-username').innerText = myName;
        document.getElementById('user-avatar').innerText = myName.substring(0, 2);

        let peer = null;
        let conn = null;
        let activeTransfers = {}; // Store transfer state by Name/ID

        // --- 3. PEERJS SETUP ---
        function initPeer() {
            // Using the generated name as the ID directly for simplicity
            peer = new Peer(myName);

            peer.on('open', (id) => {
                console.log('My ID:', id);
            });

            peer.on('connection', (connection) => {
                handleConnection(connection);
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    // Name taken? Retry with new name
                    myName = generateUsername(); 
                    initPeer();
                } else {
                    alert("Network Error: " + err.type);
                }
            });
        }
        initPeer();

        // Connect Button Logic
        function connectToPeer() {
            const target = document.getElementById('partner-id').value.trim().toUpperCase();
            if(!target) return alert("Enter a username!");
            if(target === myName) return alert("You can't connect to yourself!");
            
            const connection = peer.connect(target);
            handleConnection(connection);
        }

        function handleConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                // UI Update
                document.getElementById('connection-form').classList.add('hidden');
                document.getElementById('active-connection').classList.remove('hidden');
                document.getElementById('partner-name').innerText = conn.peer;
                
                // If I initiated, send a Hello to verify
                if(conn.peer !== myName) {
                    console.log("Connected to " + conn.peer);
                }
            });

            conn.on('data', (data) => processData(data));
            
            conn.on('close', () => {
                alert("Connection lost");
                location.reload();
            });
        }

        // --- 4. SENDING LOGIC (With ACK & Speed) ---
        const CHUNK_SIZE = 64 * 1024; // 64KB

        function triggerFileSelect() {
            if(!conn) return alert("Connect to a user first!");
            document.getElementById('file-input').click();
        }

        async function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Create UI Entry
            const transferId = Date.now(); // Unique ID for this transfer
            createTransferUI(transferId, file.name, file.size, 'upload');

            // Metadata
            conn.send({
                type: 'header',
                id: transferId,
                name: file.name,
                size: file.size,
                mime: file.type
            });

            // Start Sending
            const reader = new FileReader();
            let offset = 0;
            let lastSpeedUpdate = Date.now();
            let bytesSinceLastUpdate = 0;

            reader.onload = async (e) => {
                if(!conn) return;
                const chunk = e.target.result;
                
                // Backpressure
                while (conn.dataChannel.bufferedAmount > 10 * 1024 * 1024) {
                    await new Promise(r => setTimeout(r, 10));
                }

                conn.send({
                    type: 'chunk',
                    id: transferId,
                    data: chunk
                });

                offset += chunk.byteLength;
                bytesSinceLastUpdate += chunk.byteLength;

                // Update UI & Speed every 500ms
                const now = Date.now();
                if (now - lastSpeedUpdate >= 500) {
                    const speed = (bytesSinceLastUpdate / 1024 / 1024) / ((now - lastSpeedUpdate) / 1000); // MB/s
                    updateTransferUI(transferId, offset, file.size, speed.toFixed(1) + " MB/s", 'Sending...');
                    updateGlobalSpeed(speed);
                    
                    lastSpeedUpdate = now;
                    bytesSinceLastUpdate = 0;
                }

                if (offset < file.size) {
                    readNext();
                } else {
                    // DONE READING - Wait for ACK
                    updateTransferUI(transferId, file.size, file.size, "0 MB/s", "Waiting for receiver...");
                }
            };

            const readNext = () => {
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };
            readNext();
        }

        // --- 5. RECEIVING LOGIC ---
        const currentDownloads = {}; // Map: transferId -> { writer, received, size, name, lastUpdate, bytesSince }

        function processData(data) {
            // 1. HEADER (Start)
            if (data.type === 'header') {
                createTransferUI(data.id, data.name, data.size, 'download');
                
                const fileStream = streamSaver.createWriteStream(data.name, { size: data.size });
                currentDownloads[data.id] = {
                    writer: fileStream.getWriter(),
                    received: 0,
                    size: data.size,
                    name: data.name,
                    lastUpdate: Date.now(),
                    bytesSince: 0
                };
                return;
            }

            // 2. CHUNK (Data)
            if (data.type === 'chunk') {
                const session = currentDownloads[data.id];
                if(session && session.writer) {
                    const array = new Uint8Array(data.data);
                    session.writer.write(array);
                    session.received += array.length;
                    session.bytesSince += array.length;

                    // Update UI & Speed
                    const now = Date.now();
                    if (now - session.lastUpdate >= 500) {
                         const speed = (session.bytesSince / 1024 / 1024) / ((now - session.lastUpdate) / 1000);
                         updateTransferUI(data.id, session.received, session.size, speed.toFixed(1) + " MB/s", "Downloading...");
                         updateGlobalSpeed(speed);
                         
                         session.lastUpdate = now;
                         session.bytesSince = 0;
                    }

                    // Complete?
                    if (session.received === session.size) {
                        session.writer.close();
                        // SEND ACK TO SENDER
                        conn.send({ type: 'ack', id: data.id });
                        finalizeTransferUI(data.id, true);
                        delete currentDownloads[data.id];
                    }
                }
                return;
            }

            // 3. ACK (Completion Confirmation for Sender)
            if (data.type === 'ack') {
                finalizeTransferUI(data.id, true);
            }
        }

        // --- 6. UI MANIPULATION ---
        function createTransferUI(id, name, size, type) {
            document.getElementById('empty-state').classList.add('hidden');
            const template = document.getElementById('transfer-item-template').content.cloneNode(true);
            const el = template.querySelector('div');
            el.id = `tx-${id}`;
            
            el.querySelector('.transfer-name').innerText = name;
            el.querySelector('.transfer-size').innerText = formatBytes(size);
            
            const icon = type === 'upload' ? 'arrow-up' : 'arrow-down';
            const color = type === 'upload' ? 'text-blue-400' : 'text-green-400';
            // Simple icon set via HTML for speed
            const iconContainer = el.querySelector('.transfer-icon-bg');
            iconContainer.innerHTML = `<i data-lucide="${icon}" class="w-6 h-6 ${color}"></i>`;
            
            document.getElementById('activity-list').prepend(el);
            lucide.createIcons();
        }

        function updateTransferUI(id, current, total, speedStr, statusStr) {
            const el = document.getElementById(`tx-${id}`);
            if(!el) return;
            
            const pct = ((current / total) * 100).toFixed(1);
            el.querySelector('.transfer-bar').style.width = `${pct}%`;
            el.querySelector('.transfer-percent').innerText = `${pct}%`;
            el.querySelector('.transfer-status').innerText = `${statusStr} (${speedStr})`;
        }

        function finalizeTransferUI(id, success) {
            const el = document.getElementById(`tx-${id}`);
            if(!el) return;
            
            el.querySelector('.transfer-bar').classList.remove('bg-purple-500');
            el.querySelector('.transfer-bar').classList.add('bg-green-500');
            el.querySelector('.transfer-percent').innerText = "100%";
            el.querySelector('.transfer-status').innerText = "Transfer Complete";
            el.querySelector('.transfer-status').classList.add('text-green-400', 'font-bold');
            
            // Reset Global Speed
            document.getElementById('stat-speed').innerText = "0 MB/s";
        }

        function updateGlobalSpeed(speedVal) {
            document.getElementById('stat-speed').innerText = speedVal.toFixed(1) + " MB/s";
        }

        function copyId() {
            navigator.clipboard.writeText(myName);
            alert("Username Copied!");
        }

        function clearHistory() {
            document.getElementById('activity-list').innerHTML = `
                <div id="empty-state" class="text-center py-10 opacity-50">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-600"></i>
                    <p class="text-gray-500 text-sm">No transfers yet</p>
                </div>`;
            lucide.createIcons();
        }
    </script>
</body>
</html>
